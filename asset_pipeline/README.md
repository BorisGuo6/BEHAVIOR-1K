# BEHAVIOR-1K Asset Pipeline

This repository contains a DVC-based pipeline for converting 3D assets, primarily from the BEHAVIOR-1K project's 3ds Max format, into USD format suitable for OmniGibson simulation. It also includes data pointers to fetch the raw 3ds Max files.

## Setup

**Requirements**:

* Windows 10 or 11 with at least 32GB RAM (64GB recommended).
* Autodesk 3ds Max 2022 (Student license available).
* V-Ray 5 (Free trial available).
* Git and Conda installed.

**Installation Steps**:

1.  **Clone Repository:** Clone this repository to `D:\BEHAVIOR-1K\asset_pipeline`. **Note:** This path might be hardcoded in some scripts.
2.  **Create Conda Environment:** Open PowerShell and run:
    ```powershell
    conda env create --file environment.yml
    ```
3.  **Install 3ds Max Python Packages:** Run the following commands in PowerShell (update the 3ds Max installation path if necessary):
    ```powershell
    & 'C:\Program Files\Autodesk\3ds Max 2022\Python37\python.exe' -m ensurepip
    & 'C:\Program Files\Autodesk\3ds Max 2022\Python37\python.exe' -m pip install -r requirements_3dsmax.txt
    ```
4.  **Import 3ds Max Export Settings:** Copy `configs/gw_objexp.ini` to `%LocalAppData%\Autodesk\3dsMax\2022 - 64bit\ENU\en-US\plugcfg`, overwriting if necessary. Launch 3ds Max once if the folder doesn't exist.

## Pulling Raw BEHAVIOR-1K 3ds Max Files

This pipeline is primarily designed for the BEHAVIOR-1K 3ds Max files.

* **Licensing:** Due to licensing restrictions, raw BEHAVIOR-1K model files cannot be released to non-Stanford-affiliated users.
* **Stanford Users:**
    1.  Authenticate with Google Cloud:
        ```powershell
        gcloud auth application-default login
        ```
    2.  Pull the data using DVC:
        ```powershell
        dvc pull
        ```

## Repository Structure

```
asset_pipeline/
├── b1k_pipeline/                #-> Core pipeline scripts 
│   ├── max/                     #-> Scripts run within 3ds Max 
│   ├── usd_conversion/          #-> Scripts for URDF to USD conversion 
│   └── ...                      #-> Other pipeline modules and utilities
├── artifacts/                   #-> Pipeline output directory 
│   ├── pipeline/                #-> Intermediate outputs 
│   ├── aggregate/               #-> Aggregated outputs for the final dataset (objects, scenes, metadata) 
│   ├── parallels/               #-> Outputs from parallel processing stages (e.g., zipped objects, scenes)
│   └── og_dataset.zip           #-> Final dataset ZIP file 
├── cad/                         #-> Directory containing raw 3ds Max files 
│   ├── scenes/                  #-> Raw 3ds Max scene files 
│   │   └── {scene_name}/        #-> Data for each scene 
│   │       ├── artifacts/       #-> Scene-specific pipeline outputs [cite: 84, 85]
│   │       ├── textures/        #-> Texture files required by .max files 
│   │       ├── raw.max          #-> (Optional) Original raw scene file 
│   │       └── processed.max    #-> Processed scene file with annotations (Pipeline Input) [cite: 85, 86]
│   └── objects/                 #-> Raw 3ds Max object files (similar structure to scenes) 
├── metadata/                    #-> Metadata files (e.g., mappings, parameters) 
├── notebooks/                   #-> Jupyter notebooks for analysis, examination, etc. 
├── render_presets/              #-> Render presets for 3ds Max 
├── configs/                     #-> Configuration files (e.g., gw_objexp.ini) 
├── dvc-tmpl.yaml                #-> Template for dvc.yaml, used by generate_params.py 
├── dvc.yaml                     #-> DVC pipeline definition (generated by script) 
├── dvc.lock                     #-> DVC lockfile with dependency hashes 
├── environment.yml              #-> Conda environment definition 
└── README.md                    #-> This file
```

## Stages

The pipeline uses DVC (Data Version Control) to manage stages and dependencies. Key stages defined in `dvc.yaml` include:

| Stage Name                          | Description                                                                                                                          | Requirements             |
| :---------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------- | :----------------------- |
| `object_list`                       | Lists meshes and iGibson objects within a `.max` file.                                                                   | 3ds Max                  |
| `object_list_success`               | Aggregates and checks `object_list` results.                                                                                         |                          |
| `sanitycheck`                       | Runs tests against the `.max` file format and outputs results[cite: 146, 98].                                                         | 3ds Max                  |
| `sanitycheck_success`               | Aggregates and checks `sanitycheck` results.                                                                               |                          |
| `check_collisions`                  | Checks for collisions between objects within a scene file.                                                                 | 3ds Max                  |
| `check_collisions_success`          | Aggregates and checks `check_collisions` results.                                                                                    |                          |
| `check_collisions_with_clutter`     | Checks for collisions including clutter objects.                                                                         | 3ds Max                  |
| `check_collisions_with_clutter_success` | Aggregates and checks `check_collisions_with_clutter` results.                                                                       |                          |
| `validate_meta_links`               | Validates meta-links defined in `object_list` files[cite: 151, 152].                                                                  |                          |
| `object_inventory`                  | Aggregates object lists, checks for required objects, name collisions, etc.                                                |                          |
| `object_inventory_success`          | Checks `object_inventory` results.                                                                                                   |                          |
| `export_meshes`                     | Exports OBJ/MTL files with baked textures for each mesh in the `.max` file[cite: 155, 110].                                           | 3ds Max                  |
| `export_meshes_success`             | Aggregates and checks `export_meshes` results.                                                                             |                          |
| `generate_max_object_images`        | Renders images of individual objects within the `.max` file.                                                                 | 3ds Max                  |
| `aggregate_max_object_images`       | Aggregates the object images generated per-target[cite: 158, 172].                                                                    |                          |
| `generate_max_object_images_success`| Aggregates and checks `generate_max_object_images` results.                                                                          |                          |
| `export_objs_global`                | Processes exported meshes (OBJ/MTL) into URDF objects with joints, links, metadata[cite: 159, 114].                                   |                          |
| `export_objs_global_success`        | Checks `export_objs_global` results.                                                                                     |                          |
| `combined_room_object_list`         | Generates a combined list of objects per room across scenes, with synset mappings[cite: 161, 126].                                      |                          |
| `export_scenes_global`              | Creates scene URDF files referencing exported meshes and objects[cite: 163, 128].                                                      |                          |
| `export_scenes_global_success`      | Checks `export_scenes_global` results.                                                                                               |                          |
| `validate_scenes`                   | Runs validation checks (e.g., physics stability) on exported scene files[cite: 164, 130].                                               |                          |
| `validate_scenes_success`           | Checks `validate_scenes` results.                                                                                                    |                          |
| `usdify_objects`                    | Converts URDF objects into USD format[cite: 165, 121].                                                                                | Docker, WSL2, Windows 11 |
| `usdify_objects_success`            | Checks `usdify_objects` results.                                                                                         |                          |
| `usdify_scenes`                     | Converts scene URDFs into USD format[cite: 166, 135].                                                                                 | Docker, WSL2, Windows 11 |
| `generate_systems`                  | Generates USD system definitions (e.g., for substances) based on USD objects.                                              |                          |
| `generate_systems_success`          | Checks `generate_systems` results.                                                                                       |                          |
| `aggregate_fillable_volumes`        | Aggregates pre-generated fillable volume meshes based on annotations.                                                      |                          |
| `collision_average_volumes`         | Calculates average collision volumes per category.                                                                         |                          |
| `collision_average_volumes_success` | Checks `collision_average_volumes` results.                                                                                          |                          |
| `aggregate_metadata`                | Aggregates various metadata files (object inventory, category mappings, etc.) into a single archive[cite: 169, 177].                 |                          |
| `aggregate_metadata_success`        | Checks `aggregate_metadata` results.                                                                                                 |                          |
| `pack_dataset`                      | Packages the final aggregated objects, scenes, and metadata into a ZIP file for distribution[cite: 170, 137, 248].                   |                          |
| `patch_sampled`                     | (Optional) Patches the dataset zip files with sampled task data.                                                         | `sampled_tasks.zip`      |

*(Note: Some stages from the original README like `generate_object_images`, `validate_objs`, `generate_scene_images`, `generate_camera_images` might be deprecated or replaced by newer stages like `generate_max_object_images` and USD-based validation)*.

## Scripts

Details on the scripts powering the pipeline can be found in the [b1k_pipeline module README](./b1k_pipeline).

## Running Pipeline

*(Execution details TBD)* 

## Contributing

* Changes should be submitted via Pull Request to Cem Gokmen (cgokmen).
* **Stanford Affiliates:** Ensure relevant data changes are pushed to the cvgl storage.
* **External Users:** Provide instructions for accessing your remote storage so data can be fetched.